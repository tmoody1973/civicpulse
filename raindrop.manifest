application "hakivo" {

  // ============================================================================
  // ENVIRONMENT VARIABLES / SECRETS (for all services)
  // ============================================================================

  env "ANTHROPIC_API_KEY" {
    secret = true
  }

  env "ELEVENLABS_API_KEY" {
    secret = true
  }

  env "ELEVENLABS_SARAH_VOICE_ID" {
    secret = true
  }

  env "ELEVENLABS_JAMES_VOICE_ID" {
    secret = true
  }

  env "VULTR_STORAGE_ENDPOINT" {
    secret = true
  }

  env "VULTR_ACCESS_KEY" {
    secret = true
  }

  env "VULTR_SECRET_KEY" {
    secret = true
  }

  env "VULTR_CDN_URL" {
    secret = true
  }

  env "BRAVE_SEARCH_API_KEY" {
    secret = true
  }

  env "PEXELS_API_KEY" {
    secret = true
  }

  // Main web service - serves Next.js frontend and API endpoints
  service "web" {
    visibility = "public"
    // Automatic URL assignment for external access
  }

  // ============================================================================
  // PHASE 1: PERSONALIZATION API SERVICES
  // ============================================================================

  // Tracking Service - User interaction tracking
  service "tracking" {
    visibility = "public"
    // POST /api/tracking
    // Tracks user interactions in SmartMemory and SmartSQL
    // Accessed from Next.js frontend
  }

  // Preferences Service - User profile and widget preferences
  service "preferences" {
    visibility = "public"
    // GET/PATCH /api/preferences/profile
    // GET/PATCH /api/preferences/widgets
    // Manages user preferences and dashboard widgets
  }

  // Memory Init Service - Procedural memory initialization
  service "memory-init" {
    visibility = "public"
    // POST /api/memory/init
    // Initializes procedural memory with platform guidelines
  }

  // Admin API Service - Admin dashboard queries
  service "admin-api" {
    visibility = "public"
    // POST /api/admin/query - Execute SQL on CIVIC_DB or ANALYTICS
    // POST /api/admin/count - Get table row counts
    // Provides admin dashboard access to both databases
  }

  // SQL database - SQLite for persistent data storage
  // Renamed from civic-db to hakivo-db for fresh deployment (2025-11-10)
  sql_database "hakivo-db" {
    // Database initialized via service startup
    // Tables: users, bills, representatives, user-bills, podcasts, rss-articles, vote-records
  }

  // Optional: Bucket for podcast audio files (if audio feature enabled)
  bucket "podcast-audio" {
    // Stores generated podcast MP3 files
    // Accessed via Vultr S3-compatible API
  }

  // Bucket for temporary brief generation job data
  bucket "brief-job-storage" {
    // Stores temporary data between pipeline stages
    // Keys: job:{jobId}:metadata, job:{jobId}:bills, job:{jobId}:news,
    //       job:{jobId}:script, job:{jobId}:audio
    // Automatically cleaned up by upload-worker after brief is saved to database
  }

  // SmartBucket for bill full text - enables semantic search
  smartbucket "bills-smartbucket" {
    // Stores bill full text with AI-powered semantic search
    // Automatically indexes content for natural language queries
    // Accessed as this.env.BILLS_SMARTBUCKET
  }

  // ============================================================================
  // PERSONALIZATION & AI SYSTEM (Phase 1: Foundation)
  // ============================================================================

  // SmartMemory: User behavior tracking and learning
  smartmemory "user_memory" {
    // Multi-layered memory for personalization:
    // - Working Memory: Active session interactions
    // - Episodic Memory: Historical user behavior patterns
    // - Semantic Memory: User preferences and interests
    // - Procedural Memory: System prompts and templates
    // Accessed as this.env.USER_MEMORY
  }

  // SmartSQL: Analytics database with natural language queries
  smartsql "analytics" {
    // Stores user interactions, preferences, and analytics
    // Supports natural language queries for insights
    // Tables: user_interactions, user_profiles, widget_preferences
    // Accessed as this.env.ANALYTICS
  }

  // Queue: Recommendation engine updates
  queue "recommendation-updates" {
    // Processes background recommendation calculations
    // Triggered when user behavior changes
    // Updates user recommendations based on new data
  }

  // Observer: User behavior tracker
  observer "user-behavior-tracker" {
    source {
      queue = "recommendation-updates"
    }
    // Watches user interactions and updates:
    // 1. SmartMemory with behavior patterns
    // 2. User preference profiles
    // 3. Recommendation weights
    // 4. Engagement metrics
  }

  // ============================================================================
  // PODCAST GENERATION QUEUE SYSTEM (Actor/Observer Pattern)
  // ============================================================================

  // Queue Submission Service - Endpoint for Next.js to submit jobs
  service "queue-api" {
    visibility = "public"
    // POST /submit-podcast-job
    // Accepts podcast generation requests from Next.js (Netlify)
    // and submits them to the podcast-generation-queue
  }

  // Queue for podcast generation jobs
  queue "podcast-generation-queue" {
    // Handles asynchronous podcast generation requests
    // Max retries: 3, Visibility timeout: 300s (5 minutes)
  }

  // Actor: Manages user's podcast queue and status
  actor "podcast-generator" {
    // Per-user instance tracks:
    // - Queue of pending podcast requests
    // - Current generation status
    // - Generation history (last 10)
    // - User preferences (voice, speed, length)
    // Access via: env.PODCAST_GENERATOR.idFromName(userId)
  }

  // Observer: Processes podcast generation jobs
  observer "podcast-queue-handler" {
    source {
      queue = "podcast-generation-queue"
    }
    // Watches queue and processes each podcast request:
    // 1. Fetch bill data from SmartSQL
    // 2. Generate dialogue script (Claude API)
    // 3. Generate audio (ElevenLabs text-to-dialogue)
    // 4. Upload to Vultr CDN
    // 5. Update actor with result
    // 6. Send notification to user
  }

  // Queue for user notifications (podcast ready, bill updates, etc.)
  queue "user-notifications" {
    // Handles push notifications, emails, and in-app alerts
  }

  // Observer: Processes notification delivery
  observer "notification-handler" {
    source {
      queue = "user-notifications"
    }
    // Delivers notifications via:
    // - Push notifications (web push API)
    // - Email (future)
    // - In-app notifications (stored in KV Cache)
  }

  // KV Cache for notification state
  kv_cache "notification-state" {
    // Stores pending notifications and read status
  }

  // ============================================================================
  // DAILY BRIEF GENERATION SYSTEM (Queues + Observers + Scheduler)
  // ============================================================================

  // Test service - sends test messages to queues for testing
  service "test-service" {
    visibility = "public"
  }

  // Daily scheduler - triggers at 9am UTC to queue brief generation jobs
  task "daily-brief-scheduler" {
    type = "cron"
    cron = "0 9 * * *"  // Runs at 9:00 AM UTC daily
  }

  // ===========================================================================
  // BRIEF GENERATION PIPELINE (Memory-Optimized Multi-Worker Architecture)
  // ===========================================================================
  // Split into 5 specialized workers to stay within memory limits

  // Step 1: Initial request (from scheduler or API)
  queue "brief-queue" {
    // Entry point for brief generation requests
  }

  observer "orchestrator-worker" {
    source {
      queue = "brief-queue"
    }
    // Creates job ID, stores metadata in SmartMemory, sends to data-queue
  }

  // Step 2: Data fetching
  queue "data-queue" {
    // Fetch bills and news
  }

  observer "data-fetcher-worker" {
    source {
      queue = "data-queue"
    }
    // Fetches bills from civic-db and news from Brave Search
    // Stores results in SmartMemory with job ID
  }

  // Step 3: Script generation
  queue "script-queue" {
    // Generate dialogue script
  }

  observer "script-generator-worker" {
    source {
      queue = "script-queue"
    }
    // Reads bills+news from SmartMemory, generates dialogue with Claude
    // Stores script in SmartMemory with job ID
  }

  // Step 4: Audio generation
  queue "audio-queue" {
    // Generate podcast audio
  }

  observer "audio-generator-worker" {
    source {
      queue = "audio-queue"
    }
    // Reads script from SmartMemory, generates audio with ElevenLabs
    // Stores audio buffer in SmartMemory with job ID
  }

  // Step 5: Upload and finalize
  queue "upload-queue" {
    // Upload to CDN and save to database
  }

  observer "upload-worker" {
    source {
      queue = "upload-queue"
    }
    // Reads audio from SmartMemory, uploads to Vultr CDN
    // Saves brief to database, cleans up SmartMemory
  }

  // News generation queue - stores news fetch requests
  queue "news-queue" {
    // Handles news fetching and image generation (20-30 seconds per job)
  }

  // News worker - processes personalized news jobs from queue
  observer "news-worker" {
    source {
      queue = "news-queue"
    }
    // Processes: fetch news from Brave API, get topic images from Pexels
    // No execution time limit
  }
}
